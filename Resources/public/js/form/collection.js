define("ekyna-media/form/collection",["jquery","routing","ekyna-modal","ekyna-media/browser","ekyna-media/templates","jquery-ui/ui/widgets/sortable"],function(d,t,a,l,c){"use strict";function i(e){this.$elem=d(e),this.defaults={types:[],controls:[{role:"move-left",icon:"arrow-left",title:"Move left"},{role:"remove",icon:"remove",title:"Remove"},{role:"move-right",icon:"arrow-right",title:"Move right"}],limit:0},this.config=d.extend({},this.defaults,this.$elem.data("config"))}return i.prototype={constructor:i,init:function(){var t=this;t.$elem.closest("form").on("submit",function(){t.$elem.find(".ekyna-media-collection-add input").remove()}),t.$elem.on("click",'.ekyna-media-collection-media [data-role="move-left"]',function(e){e.preventDefault(),t.moveLeft(d(e.target).closest(".ekyna-media-collection-media"))}),t.$elem.on("click",'.ekyna-media-collection-media [data-role="move-right"]',function(e){e.preventDefault(),t.moveRight(d(e.target).closest(".ekyna-media-collection-media"))}),t.$elem.on("click",'.ekyna-media-collection-media [data-role="remove"]',function(e){e.preventDefault(),t.removeMedia(d(e.target).closest(".ekyna-media-collection-media"),!0)}),t.$elem.on("click",".ekyna-media-collection-add",function(e){e.preventDefault(),t.addMedias()}),t.$elem.sortable({delay:150,items:".ekyna-media-collection-media",placeholder:"ekyna-media-collection-placeholder",containment:"parent",update:function(){t.updateCollection()}}),t.updateCollection()},addMedias:function(){var i,o=this,n=new a,e=(d(n).on("ekyna.modal.content",function(e){if("html"!==e.contentType)throw"Unexpected modal content type.";i=new l(e.content),d(i).bind("ekyna.media-browser.media_delete",function(t){t.hasOwnProperty("media")&&o.$elem.find(".ekyna-media-collection-media").not(".ekyna-media-collection-add").each(function(){var e=d(this);t.media.id===e.find("input").val()&&o.removeMedia(e,!1)})})}),d(n).on("ekyna.modal.load_fail",function(){alert("Failed to load media browser.")}),d(n).on("ekyna.modal.button_click",function(e){if("submit"===e.buttonId&&i){var t,a=i.getSelection();for(t in a)a.hasOwnProperty(t)&&o.createMedia(a[t]);o.updateCollection(),n.getDialog().close()}}),d(n).on("ekyna.modal.shown",function(){i&&i.init()}),d(n).on("ekyna.modal.hide",function(){i=i&&null}),{mode:"multiple_selection"});0<o.config.types.length&&(e.types=this.config.types),n.load({url:t.generate("admin_ekyna_media_browser_modal",e)})},updateCollection:function(){var e=this.$elem.find(".ekyna-media-collection-media").not(".ekyna-media-collection-add"),a=e.length-1;e.each(function(e){var t=d(this);t.find('input[data-role="position"]').val(e),0===e?t.find('[data-role="move-left"]').addClass("disabled"):t.find('[data-role="move-left"]').removeClass("disabled"),e===a?t.find('[data-role="move-right"]').addClass("disabled"):t.find('[data-role="move-right"]').removeClass("disabled")}),this.createAddButton()},createMedia:function(e){for(var t=this.$elem.attr("data-prototype"),a=this.$elem.attr("data-prototype-name"),i=this.$elem.find(".ekyna-media-collection-media").length,o=t.match(/id="(.*?)"/),n=new RegExp(a,"g");0<d("#"+o[1].replace(n,i)).length;)i++;t=(t=t.replace(n,i)).replace(/__id__/g,o[1].replace(n,i)),a=d(t),a.removeClass("ekyna-media-collection-add"),t=d(c["@EkynaMedia/Js/thumb.html.twig"].render({media:e,controls:this.config.controls,selector:!1}));t.data("media",e),a.find(".media-thumb").replaceWith(t),a.find("input").val(e.id),this.$elem.append(a)},createAddButton:function(){var e=this,t=e.$elem.find(".ekyna-media-collection-add");if(1!==t.length){1<t.length&&t.remove();for(var a=this.$elem.attr("data-prototype"),i=this.$elem.attr("data-prototype-name"),o=this.$elem.find(".ekyna-media-collection-media").length,n=a.match(/id="(.*?)"/),l=new RegExp(i,"g");0<d("#"+n[1].replace(l,o)).length;)o++;a=(a=a.replace(l,o)).replace(/__id__/g,n[1].replace(l,o)),i=d(a);e.$elem.append(i)}else t.detach().appendTo(e.$elem)},moveLeft:function(e){e.find('[data-role="move-left"]').hasClass("disabled")||(e.prev().before(e.detach()),this.updateCollection())},moveRight:function(e){e.find('[data-role="move-right"]').hasClass("disabled")||(e.next().after(e.detach()),this.updateCollection())},removeMedia:function(e,t){e.find('[data-role="remove"]').hasClass("disabled")||t&&!confirm("Souhaitez-vous réellement retirer cet élément ?")||(e.remove(),this.updateCollection())}},{init:function(e){e.each(function(){new i(d(this)).init()})}}});