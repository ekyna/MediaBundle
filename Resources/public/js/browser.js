define("ekyna-media/browser",["require","jquery","routing","ekyna-modal","ekyna-form","ekyna-media/player","ekyna-media/templates","ekyna-string","fancybox","fancytree"],function(a,b,c,d,e,f,g){"use strict";b.fn.sortElements=function(){var a=[].sort;return function(b,c){c=c||function(){return this};var d=this.map(function(){var a=c.call(this),b=a.parentNode,d=b.insertBefore(document.createTextNode(""),a.nextSibling);return function(){if(b===this)throw new Error("You can't sort elements if any one is a descendant of another.");b.insertBefore(this,d),b.removeChild(d)}});return a.call(this,b).each(function(a){d[a].call(c.call(this))})}}();var h={mode:"browse",folderId:null,types:[],sortBy:"filename",sortDir:"asc",search:"",debug:!0},i=function(a){this.$browser=b(a),this.config=b.extend({},h,this.$browser.data("config")),this.$tree=this.$browser.find(".media-browser-tree"),this.$content=this.$browser.find(".media-browser-content"),this.$controls=this.$browser.find(".media-browser-controls"),this.modal=null,this.busy=!1,this.folderId=null,this.browseXhr=null};return i.prototype={constructor:i,init:function(a){if(this.config=b.extend({},this.config,a||{}),-1===b.inArray(this.config.mode,["browse","single_selection","multiple_selection","tinymce"]))throw'Unexpected browser mode "'+this.config.mode+'".';this.initTree(),this.$controls.find("button, label").addClass("disabled").prop("disabled",!0),this.$controls.find("input").prop("disabled",!0)},setBusy:function(a){a&&this.browseXhr&&this.browseXhr.abort(),this.busy!==a&&(this.busy=a,this.busy?(this.clearHandlers(),this.$controls.find("button, label").addClass("disabled").prop("disabled",!0),this.$controls.find("input").prop("disabled",!0),this.$controls.find('[data-role="refresh"] span').addClass("refresh-animate")):(this.initHandlers(),this.$controls.find("button, label").removeClass("disabled").prop("disabled",!1),this.$controls.find("input").prop("disabled",!1),this.$controls.find('[data-role="refresh"] span').removeClass("refresh-animate")))},initHandlers:function(){var a=this;this.$controls.on("click",'[data-role="create"]',function(b){b.preventDefault(),b.stopPropagation(),a.newMedia()}),this.$controls.on("click",'[data-role="import"]',function(b){b.preventDefault(),b.stopPropagation(),a.importMedia()}),this.$controls.on("click",'[data-role="refresh"]',function(b){b.preventDefault(),b.stopPropagation(),a.browse()}),this.$controls.on("change",'input[name="filters[]"]',function(b){b.preventDefault(),b.stopPropagation(),a.filterList()});var c=null;this.$controls.on("keyup",'input[data-role="search"]',function(b){b.preventDefault(),b.stopPropagation(),clearTimeout(c),c=setTimeout(function(){a.filterList()},1500)}),this.$controls.on("click",'button[data-role="clear-search"]',function(b){b.preventDefault(),b.stopPropagation(),clearTimeout(c),a.$controls.find('input[data-role="search"]').val(""),a.filterList()}),this.$controls.on("click",'[data-role="sort"]',function(a){a.preventDefault();var c=b(a.currentTarget).find("input"),d=b(a.currentTarget).find("span.glyphicon");if(c.is(":checked")){var e="filename"===c.val()?"glyphicon-sort-by-alphabet":"glyphicon-sort-by-attributes";"asc"===c.data("dir")?(d.removeClass(e).addClass(e+"-alt"),c.data("dir","desc")):(d.removeClass(e+"-alt").addClass(e),c.data("dir","asc")),c.trigger("change")}}),this.$controls.on("change",'input[name="sort"]',function(b){b.preventDefault(),b.stopPropagation(),a.sortList()}),this.$content.on("click",'.media-thumb [data-role="select"]',function(c){c.preventDefault(),c.stopPropagation();var d=b(c.currentTarget).parents(".media-thumb").eq(0);if("tinymce"===a.config.mode&&parent.tinymce&&parent.tinymce.activeEditor)parent.tinymce.activeEditor.windowManager.getParams().setUrl(d.data("media").front),parent.tinymce.activeEditor.windowManager.close();else if("single_selection"===a.config.mode){var e=jQuery.Event("ekyna.media-browser.selection");e.media=d.data("media"),b(a).trigger(e)}else if("multiple_selection"===a.config.mode){var f=d.find('input[type="checkbox"]');f.prop("checked",!f.is(":checked"))}}),this.$content.on("click",'.media-thumb [data-role="edit"]',function(c){c.preventDefault(),c.stopPropagation();var d=b(c.currentTarget).parents(".media-thumb");a.editMedia(d)}),this.$content.on("click",'.media-thumb [data-role="delete"]',function(c){c.preventDefault(),c.stopPropagation();var d=b(c.currentTarget).parents(".media-thumb");a.removeMedia(d)})},clearHandlers:function(){this.$controls.off(),this.$content.off()},browse:function(a){var d=this;d.$content.empty(),this.folderId=a?a:this.config.folderId,this.folderId&&(d.setBusy(!0),d.browseXhr=b.ajax({url:c.generate("admin_ekyna_media_browser_list_media",{id:this.folderId}),method:"GET",dataType:"json",data:{types:d.config.types}}).done(function(a){if(a.error)return void alert(a.message);if(a.hasOwnProperty("medias")){var c=!1;"multiple_selection"===d.config.mode&&(c=!0);var e=[{role:"show",icon:"play",title:"Preview"},{role:"edit",icon:"pencil",title:"Edit"},{role:"delete",icon:"trash",title:"Delete"},{role:"download",icon:"download",title:"Download"}];b(a.medias).each(function(a,f){b(g["@EkynaMedia/Js/thumb.html.twig"].render({media:f,controls:e,selector:c})).data("media",f).appendTo(d.$content).draggable({revert:"invalid",cursorAt:{top:-5,left:-5},appendTo:d.$browser,delay:200,containement:d.$browser,scroll:!1,connectToFancytree:!0,helper:function(a){return b(a.currentTarget).clone()}})}),d.sortList(),d.filterList()}d.browseXhr=null}).fail(function(){}).always(function(){d.setBusy(!1)}))},openModal:function(a){var c=b.extend({},{url:null,onData:function(){},onShow:function(a){},onHide:function(){}},a);if(!c.url)throw"Modal url is not defined";var e=this;e.setBusy(!0),e.modal=new d,b(e.modal).on("ekyna.modal.response",function(a){"json"===a.contentType&&(a.preventDefault(),c.onData(a.content),e.browse(),a.modal.close())}),b(e.modal).on("ekyna.modal.load_fail",function(){e.setBusy(!1)}),b(e.modal).on("ekyna.modal.hide",function(){c.onHide(),e.setBusy(!1)}),e.modal.load({url:c.url})},newMedia:function(){this.openModal({url:c.generate("admin_ekyna_media_browser_create_media",{id:this.folderId})})},importMedia:function(){this.openModal({url:c.generate("admin_ekyna_media_browser_import_media",{id:this.folderId})})},editMedia:function(a){this.openModal({url:c.generate("admin_ekyna_media_media_update",{mediaId:a.data("media").id})})},removeMedia:function(a){var d=this;this.openModal({url:c.generate("admin_ekyna_media_media_delete",{mediaId:a.data("media").id}),onData:function(c){if(c.hasOwnProperty("success")&&c.success){var e=jQuery.Event("ekyna.media-browser.media_delete");e.media=a.data("media"),b(d).trigger(e)}}})},filterList:function(){var a=this.$controls.find('input[name="filters[]"]:checked').map(function(a,c){return b(c).val()}).get(),c=this.$controls.find('input[name="search"]').val();if(a.length>0||c.length>0){var d=new RegExp(c.removeDiatrics().escapeRegExp(),"i");this.$content.find(".media-thumb").each(function(e,f){var g=b(f),h=g.data("media").type;a.length>0&&(0>b.inArray(h,a)?g.hide():g.show()),c.length>0&&(d.test(g.data("media").filename.removeDiatrics())?g.show():g.hide())})}else this.$content.find(".media-thumb").show()},sortList:function(){var a=b(this.$controls.find('input[name="sort"]:checked')),c=a.val(),d="asc"===a.data("dir")?1:-1;this.$content.find(".media-thumb").sortElements(function(a,e){return b(a).data("media")[c]>b(e).data("media")[c]?d:-d})},getSelection:function(){if("multiple_selection"!==this.config.mode)return[];var a=[];return this.$content.find('input[name="thumb_selection[]"]:checked').each(function(c,d){a.push(b(d).closest(".media-thumb").data("media"))}),a},initTree:function(){var a=this;this.$tree.addClass("fancytree-expander").fancytree({source:{url:c.generate("admin_ekyna_media_browser_list",a.config.folderId?{folderId:a.config.folderId}:{})},activeVisible:!0,minExpandLevel:1,selectMode:1,extensions:["edit","dnd","glyph"],init:function(b,c){var d=c.tree.getActiveNode();d&&(d.setExpanded(!0),a.browse(d.key))},activate:function(b,c){a.browse(c.node.key)},glyph:{map:{doc:"glyphicon glyphicon-file",docOpen:"glyphicon glyphicon-file",checkbox:"glyphicon glyphicon-unchecked",checkboxSelected:"glyphicon glyphicon-check",checkboxUnknown:"glyphicon glyphicon-share",dragHelper:"glyphicon glyphicon-play",dropMarker:"glyphicon glyphicon-arrow-right",error:"glyphicon glyphicon-warning-sign",expanderClosed:"glyphicon glyphicon-menu-right",expanderLazy:"glyphicon glyphicon-menu-right",expanderOpen:"glyphicon glyphicon-menu-down",folder:"glyphicon glyphicon-folder-close",folderOpen:"glyphicon glyphicon-folder-open",loading:"glyphicon glyphicon-refresh glyphicon-spin"}},dnd:{preventVoidMoves:!0,preventRecursiveMoves:!0,autoExpandMS:400,dragStart:function(a){return a.data.level>0},dragEnter:function(){return["over"]},dragDrop:function(d,e){if(a.setBusy(!0),e.otherNode){var f=e.otherNode;b.ajax({url:c.generate("admin_ekyna_media_browser_move",{id:f.key}),data:{reference:d.key,mode:e.hitMode},method:"POST",dataType:"json"}).done(function(b){return b.error?void alert(b.message):(f.moveTo(d,e.hitMode),void a.setBusy(!1))}).fail(function(){a.setBusy(!1)})}else{var g=b(e.draggable.element);g.hasClass("media-thumb")&&b.ajax({url:c.generate("admin_ekyna_media_browser_move_media",{id:d.key,mediaId:g.data("media").id}),method:"POST",dataType:"json"}).done(function(){a.browse()}).fail(function(){a.setBusy(!1)})}}},edit:{triggerStart:["f2","dblclick","shift+click","mac+enter"],adjustWidthOfs:4,beforeEdit:function(a,b){return b.node.data.level>0},beforeClose:function(a,b){return b.input.val().length>0},save:function(d,e){a.setBusy(!0);var f=e.node;return b.ajax({url:c.generate("admin_ekyna_media_browser_rename",{id:f.key}),data:{name:e.input.val()},method:"POST",dataType:"json"}).done(function(a){return a.error?(f.setTitle(e.orgTitle),void alert(a.message)):(f.setTitle(a.name),void f.setActive())}).fail(function(){f.setTitle(e.orgTitle)}).always(function(){b(e.node.span).removeClass("pending"),a.setBusy(!1)}),!0},close:function(a,c){c.save&&b(c.node.span).addClass("pending")}}});var d=function(d,e){a.setBusy(!0),e=e||"child",b.ajax({url:c.generate("admin_ekyna_media_browser_create",{id:d.key}),data:{mode:e},method:"POST",dataType:"json"}).done(function(a){return a.error?void alert(a.message):void d.editCreateNode(e,a.node)}).always(function(){a.setBusy(!1)})},e=function(d){a.setBusy(!0);var e='Êtes-vous sûr de vouloir supprimer le dossier "'+d.title+'"';d.children&&d.children.length&&(e+=" et tous ses sous-dossiers"),e+=" ?",confirm(e)&&b.ajax({url:c.generate("admin_ekyna_media_browser_delete",{id:d.key}),method:"POST",dataType:"json"}).done(function(a){if(a.error)return void alert(a.message);var b=d.getNextSibling()||d.getPrevSibling()||d.getParent();d.remove(),b&&b.setActive()}).always(function(){a.setBusy(!1)})};this.$tree.on("nodeCommand",function(a,c){var f=b(this).fancytree("getTree").getActiveNode();switch(c.cmd){case"rename":f.editStart();break;case"remove":e(f);break;case"addChild":d(f,"child");break;case"addSibling":d(f,"after");break;default:return void alert("Unhandled command: "+c.cmd)}}),this.$tree.contextmenu({delegate:"span.fancytree-node",menu:[{title:"Modifier",cmd:"rename",uiIcon:"ui-icon-pencil"},{title:"Supprimer",cmd:"remove",uiIcon:"ui-icon-trash"},{title:"Ajouter suivant",cmd:"addSibling",uiIcon:"ui-icon-plus"},{title:"Ajouter enfant",cmd:"addChild",uiIcon:"ui-icon-arrowreturn-1-e"}],beforeOpen:function(c,d){var e=b.ui.fancytree.getNode(d.target);e.setActive(),b(a.$tree).contextmenu("showEntry","addSibling",e.data.level>0).contextmenu("showEntry","rename",e.data.level>0).contextmenu("showEntry","remove",e.data.level>0)},select:function(a,c){var d=this;setTimeout(function(){b(d).trigger("nodeCommand",{cmd:c.cmd})},100)}})}},i});