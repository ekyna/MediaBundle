define("ekyna-media/browser",["require","jquery","routing","ekyna-modal","ekyna-form","ekyna-media/player","ekyna-media/templates","ekyna-string","fancybox","fancytree/jquery.fancytree.dnd","fancytree/jquery.fancytree.edit","fancytree/jquery.fancytree.glyph","fancytree/jquery.fancytree.contextMenu"],function(e,r,a,i,t,l,s){"use strict";function n(e){this.$browser=r(e),this.config=r.extend({},d,this.$browser.data("config")),this.$tree=this.$browser.find(".media-browser-tree"),this.$content=this.$browser.find(".media-browser-content"),this.$controls=this.$browser.find(".media-browser-controls"),this.modal=null,this.busy=!1,this.folderId=null,this.browseXhr=null}r.fn.sortElements=(o=[].sort,function(e,i){i=i||function(){return this};var t=this.map(function(){var e=i.call(this),t=e.parentNode,n=t.insertBefore(document.createTextNode(""),e.nextSibling);return function(){if(t===this)throw new Error("You can't sort elements if any one is a descendant of another.");t.insertBefore(this,n),t.removeChild(n)}});return o.call(this,e).each(function(e){t[e].call(i.call(this))})});var o,d={mode:"browse",folderId:null,types:[],sortBy:"filename",sortDir:"asc",search:"",debug:!0};return n.prototype={constructor:n,init:function(e){if(this.config=r.extend({},this.config,e||{}),-1===r.inArray(this.config.mode,["browse","single_selection","multiple_selection","tinymce"]))throw'Unexpected browser mode "'+this.config.mode+'".';this.initTree(),this.$controls.find("button, label").addClass("disabled").prop("disabled",!0),this.$controls.find("input").prop("disabled",!0)},setBusy:function(e){e&&this.browseXhr&&this.browseXhr.abort(),this.busy!==e&&(this.busy=e,this.busy?(this.clearHandlers(),this.$controls.find("button, label").addClass("disabled").prop("disabled",!0),this.$controls.find("input").prop("disabled",!0),this.$controls.find('[data-role="refresh"] span').addClass("refresh-animate")):(this.initHandlers(),this.$controls.find("button, label").removeClass("disabled").prop("disabled",!1),this.$controls.find("input").prop("disabled",!1),this.$controls.find('[data-role="refresh"] span').removeClass("refresh-animate")))},initHandlers:function(){var n=this,t=(this.$controls.on("click",'[data-role="create"]',function(e){e.preventDefault(),e.stopPropagation(),n.newMedia()}),this.$controls.on("click",'[data-role="import"]',function(e){e.preventDefault(),e.stopPropagation(),n.importMedia()}),this.$controls.on("click",'[data-role="refresh"]',function(e){e.preventDefault(),e.stopPropagation(),n.browse()}),this.$controls.on("change",'input[name="filters[]"]',function(e){e.preventDefault(),e.stopPropagation(),n.filterList()}),null);this.$controls.on("keyup",'input[data-role="search"]',function(e){e.preventDefault(),e.stopPropagation(),clearTimeout(t),t=setTimeout(function(){n.filterList()},1500)}),this.$controls.on("click",'button[data-role="clear-search"]',function(e){e.preventDefault(),e.stopPropagation(),clearTimeout(t),n.$controls.find('input[data-role="search"]').val(""),n.filterList()}),this.$controls.on("click",'[data-role="sort"]',function(e){e.preventDefault();var t,n=r(e.currentTarget).find("input"),e=r(e.currentTarget).find("span.glyphicon");n.is(":checked")&&(t="filename"===n.val()?"glyphicon-sort-by-alphabet":"glyphicon-sort-by-attributes","asc"===n.data("dir")?(e.removeClass(t).addClass(t+"-alt"),n.data("dir","desc")):(e.removeClass(t+"-alt").addClass(t),n.data("dir","asc")),n.trigger("change"))}),this.$controls.on("change",'input[name="sort"]',function(e){e.preventDefault(),e.stopPropagation(),n.sortList()}),this.$content.on("click",'.media-thumb [data-role="select"]',function(e){e.preventDefault(),e.stopPropagation();var t,e=r(e.currentTarget).parents(".media-thumb").eq(0);"tinymce"===n.config.mode&&parent.tinymce&&parent.tinymce.activeEditor?(parent.tinymce.activeEditor.windowManager.getParams().setUrl(e.data("media").front),parent.tinymce.activeEditor.windowManager.close()):"single_selection"===n.config.mode?((t=jQuery.Event("ekyna.media-browser.selection")).media=e.data("media"),r(n).trigger(t)):"multiple_selection"===n.config.mode&&(t=e.find('input[type="checkbox"]')).prop("checked",!t.is(":checked"))}),this.$content.on("click",'.media-thumb [data-role="edit"]',function(e){e.preventDefault(),e.stopPropagation();e=r(e.currentTarget).parents(".media-thumb");n.editMedia(e)}),this.$content.on("click",'.media-thumb [data-role="delete"]',function(e){e.preventDefault(),e.stopPropagation();e=r(e.currentTarget).parents(".media-thumb");n.removeMedia(e)})},clearHandlers:function(){this.$controls.off(),this.$content.off()},browse:function(e){var o=this;o.$content.empty(),this.folderId=e||this.config.folderId,this.folderId&&(o.setBusy(!0),o.browseXhr=r.ajax({url:a.generate("admin_ekyna_media_browser_list_media",{id:this.folderId}),method:"GET",dataType:"json",data:{types:o.config.types}}).done(function(e){var n,i;e.error?alert(e.message):(e.hasOwnProperty("medias")&&(n=!1,"multiple_selection"===o.config.mode&&(n=!0),i=[{role:"show",icon:"play",title:"Preview"},{role:"edit",icon:"pencil",title:"Edit"},{role:"delete",icon:"trash",title:"Delete"},{role:"download",icon:"download",title:"Download"}],r(e.medias).each(function(e,t){r(s["@EkynaMedia/Js/thumb.html.twig"].render({media:t,controls:i,selector:n})).data("media",t).appendTo(o.$content).draggable({revert:"invalid",cursorAt:{top:-5,left:-5},appendTo:o.$browser,delay:200,containement:o.$browser,scroll:!1,connectToFancytree:!0,helper:function(e){return r(e.currentTarget).clone()}})}),o.sortList(),o.filterList()),o.browseXhr=null)}).fail(function(){}).always(function(){o.setBusy(!1)}))},openModal:function(e){var t=r.extend({},{url:null,onData:function(){},onShow:function(e){},onHide:function(){}},e);if(!t.url)throw"Modal url is not defined";var n=this;n.setBusy(!0),n.modal=new i,r(n.modal).on("ekyna.modal.response",function(e){"json"===e.contentType&&(e.preventDefault(),t.onData(e.content),n.browse(),e.modal.close())}),r(n.modal).on("ekyna.modal.load_fail",function(){n.setBusy(!1)}),r(n.modal).on("ekyna.modal.hide",function(){t.onHide(),n.setBusy(!1)}),n.modal.load({url:t.url})},newMedia:function(){this.openModal({url:a.generate("admin_ekyna_media_browser_create_media",{id:this.folderId})})},importMedia:function(){this.openModal({url:a.generate("admin_ekyna_media_browser_import_media",{id:this.folderId})})},editMedia:function(e){this.openModal({url:a.generate("admin_ekyna_media_media_update",{mediaId:e.data("media").id})})},removeMedia:function(t){var n=this;this.openModal({url:a.generate("admin_ekyna_media_media_delete",{mediaId:t.data("media").id}),onData:function(e){e.hasOwnProperty("success")&&e.success&&((e=jQuery.Event("ekyna.media-browser.media_delete")).media=t.data("media"),r(n).trigger(e))}})},filterList:function(){var i,o=this.$controls.find('input[name="filters[]"]:checked').map(function(e,t){return r(t).val()}).get(),a=this.$controls.find('input[name="search"]').val();0<o.length||0<a.length?(i=new RegExp(a.removeDiatrics().escapeRegExp(),"i"),this.$content.find(".media-thumb").each(function(e,t){var t=r(t),n=t.data("media").type;0<o.length&&(r.inArray(n,o)<0?t.hide():t.show()),0<a.length&&(i.test(t.data("media").filename.removeDiatrics())?t.show():t.hide())})):this.$content.find(".media-thumb").show()},sortList:function(){var e=r(this.$controls.find('input[name="sort"]:checked')),n=e.val(),i="asc"===e.data("dir")?1:-1;this.$content.find(".media-thumb").sortElements(function(e,t){return r(e).data("media")[n]>r(t).data("media")[n]?i:-i})},getSelection:function(){if("multiple_selection"!==this.config.mode)return[];var n=[];return this.$content.find('input[name="thumb_selection[]"]:checked').each(function(e,t){n.push(r(t).closest(".media-thumb").data("media"))}),n},createFolder:function(t,n){this.setBusy(!0),n=n||"child",r.ajax({url:a.generate("admin_ekyna_media_browser_create",{id:t.key}),data:{mode:n},method:"POST",dataType:"json"}).done(function(e){e.error?alert(e.message):t.editCreateNode(n,e.node)}).always(()=>{this.setBusy(!1)})},deleteFolder:function(t){this.setBusy(!0);var e='Êtes-vous sûr de vouloir supprimer le dossier "'+t.title+'"';t.children&&t.children.length&&(e+=" et tous ses sous-dossiers"),e+=" ?",confirm(e)&&r.ajax({url:a.generate("admin_ekyna_media_browser_delete",{id:t.key}),method:"POST",dataType:"json"}).done(function(e){e.error?alert(e.message):(e=t.getNextSibling()||t.getPrevSibling()||t.getParent(),t.remove(),e&&e.setActive())}).always(()=>{this.setBusy(!1)})},initTree:function(){var o=this;this.$tree.addClass("fancytree-expander").fancytree({source:{url:a.generate("admin_ekyna_media_browser_list",o.config.folderId?{folderId:o.config.folderId}:{})},activeVisible:!0,minExpandLevel:1,selectMode:1,extensions:["edit","dnd","glyph","contextMenu"],init:function(e,t){t=t.tree.getActiveNode();t&&(t.setExpanded(!0),o.browse(t.key))},activate:function(e,t){o.browse(t.node.key)},glyph:{map:{doc:"glyphicon glyphicon-file",docOpen:"glyphicon glyphicon-file",checkbox:"glyphicon glyphicon-unchecked",checkboxSelected:"glyphicon glyphicon-check",checkboxUnknown:"glyphicon glyphicon-share",dragHelper:"glyphicon glyphicon-play",dropMarker:"glyphicon glyphicon-arrow-right",error:"glyphicon glyphicon-warning-sign",expanderClosed:"glyphicon glyphicon-menu-right",expanderLazy:"glyphicon glyphicon-menu-right",expanderOpen:"glyphicon glyphicon-menu-down",folder:"glyphicon glyphicon-folder-close",folderOpen:"glyphicon glyphicon-folder-open",loading:"glyphicon glyphicon-refresh glyphicon-spin"}},dnd:{preventVoidMoves:!0,preventRecursiveMoves:!0,autoExpandMS:400,dragStart:function(e){return 0<e.data.level},dragEnter:function(){return["over"]},dragDrop:function(t,n){var i,e;o.setBusy(!0),n.otherNode?(i=n.otherNode,r.ajax({url:a.generate("admin_ekyna_media_browser_move",{id:i.key}),data:{reference:t.key,mode:n.hitMode},method:"POST",dataType:"json"}).done(function(e){e.error?alert(e.message):(i.moveTo(t,n.hitMode),o.setBusy(!1))}).fail(function(){o.setBusy(!1)})):(e=r(n.draggable.element)).hasClass("media-thumb")&&r.ajax({url:a.generate("admin_ekyna_media_browser_move_media",{id:t.key,mediaId:e.data("media").id}),method:"POST",dataType:"json"}).done(function(){o.browse()}).fail(function(){o.setBusy(!1)})}},edit:{triggerStart:["f2","dblclick","shift+click","mac+enter"],adjustWidthOfs:4,beforeEdit:function(e,t){return 0<t.node.data.level},beforeClose:function(e,t){return 0<t.input.val().length},save:function(e,t){o.setBusy(!0);var n=t.node;return r.ajax({url:a.generate("admin_ekyna_media_browser_rename",{id:n.key}),data:{name:t.input.val()},method:"POST",dataType:"json"}).done(function(e){if(e.error)return n.setTitle(t.orgTitle),void alert(e.message);n.setTitle(e.name),n.setActive()}).fail(function(){n.setTitle(t.orgTitle)}).always(function(){r(t.node.span).removeClass("pending"),o.setBusy(!1)}),!0},close:function(e,t){t.save&&r(t.node.span).addClass("pending")}},contextMenu:{menu:e=>({edit:{name:"Modifier",icon:"fa-pencil",disabled:0===e.data.level},delete:{name:"Supprimer",icon:"fa-trash",disabled:0===e.data.level},addSibling:{name:"Créer dossier",icon:"fa-plus",disabled:0===e.data.level},addChild:{name:"Créer sous-dossier",icon:"fa-arrow-down"}}),actions:{edit:e=>{e.editStart()},delete:e=>{o.deleteFolder(e)},addSibling:e=>{o.createFolder(e,"after")},addChild:e=>{o.createFolder(e,"child")}}}})}},n});