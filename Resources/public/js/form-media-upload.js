define("ekyna-form/media-upload",["jquery","jquery/fileupload","jquery/qtip"],function(a){"use strict";var b=function(b){this.$elem=a(b),this.defaults={},this.config=a.extend({},this.defaults,this.$elem.data("config"))};return b.prototype={constructor:b,init:function(){var b=this,c=b.$elem.find(".ekyna-media-upload-input").eq(0),d=b.$elem.find(".ekyna-collection").eq(0),e=d.find('[data-collection-role="add"]').eq(0).hide(),f=c.closest("form"),g=f.find("[type=submit]");0==g.length&&(g=f.closest(".modal-content").find("button#submit")),b.$elem.find(".file-input-button").on("click",function(a){a.preventDefault(),a.stopPropagation(),c.trigger("click")}),c.fileupload({dropZone:b.$elem.find(".ekyna-media-upload-drop-zone").eq(0)}).bind("fileuploadadd",function(b,c){a.each(c.files,function(a,b){d.one("ekyna-collection-field-added",function(a){var d=a.target;d.data(c),d.find("input:text").eq(0).val(b.name),c.context=d}),e.trigger("click")})}).bind("fileuploadsubmit",function(a,b){var c=f.data("uploadCount")||0;c++,g.prop("disabled",!0),f.data("uploadCount",c)}).bind("fileuploadalways",function(){var a=f.data("uploadCount")||0;a--,f.data("uploadCount",a),0>=a&&g.prop("disabled",!1)}).bind("fileuploaddone",function(a,b){var c=JSON.parse(b.result);b.context&&(c.hasOwnProperty("upload_key")?(b.context.find("input[type=hidden]").val(c.upload_key),b.context.find(".progress-bar").addClass("progress-bar-success")):(b.context.addClass("has-error").find("input").prop("disabled",!0),b.context.find(".progress-bar").addClass("progress-bar-danger")))}).bind("fileuploadprogress",function(a,b){if(b.context&&b._progress){var c=parseInt(b._progress.loaded/b._progress.total*100,10);b.context.find(".progress-bar").css({width:c+"%"}).attr("aria-valuenow",c)}}),d.on("ekyna-collection-field-removed",function(a){a.target.data.abort&&a.target.data.abort()}),f.bind("submit",function(a){var b=f.data("uploadCount")||0;if(0<b)return g.qtip({content:"Veuillez patienter pendant le téléchargement de vos fichiers&hellip;",style:{classes:"qtip-bootstrap"},hide:{fixed:!0,delay:300},position:{my:"bottom center",at:"top center",target:"mouse",adjust:{mouse:!1,scroll:!1}}}),a.preventDefault(),!1})}},{init:function(c){c.each(function(){new b(a(this)).init()})}}});