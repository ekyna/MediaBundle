define("ekyna-form/media-collection",["jquery","routing","twig","ekyna-modal","ekyna-media-browser","jquery-ui/sortable"],function(a,b,c,d,e){"use strict";var f=function(b){this.$elem=a(b),this.defaults={types:[],controls:[{role:"move-left",icon:"arrow-left"},{role:"remove",icon:"remove"},{role:"move-right",icon:"arrow-right"}],limit:0},this.config=a.extend({},this.defaults,this.$elem.data("config"))};return f.prototype={constructor:f,init:function(){var b=this;b.$elem.closest("form").on("submit",function(){b.$elem.find(".ekyna-media-collection-add input").remove()}),b.$elem.on("click",'.ekyna-media-collection-media [data-role="move-left"]',function(c){c.preventDefault(),b.moveLeft(a(c.target).closest(".ekyna-media-collection-media"))}),b.$elem.on("click",'.ekyna-media-collection-media [data-role="move-right"]',function(c){c.preventDefault(),b.moveRight(a(c.target).closest(".ekyna-media-collection-media"))}),b.$elem.on("click",'.ekyna-media-collection-media [data-role="remove"]',function(c){c.preventDefault(),b.removeMedia(a(c.target).closest(".ekyna-media-collection-media"),!0)}),b.$elem.on("click",".ekyna-media-collection-add",function(a){a.preventDefault(),b.addMedias()}),b.$elem.sortable({delay:150,items:".ekyna-media-collection-media",placeholder:"ekyna-media-collection-placeholder",containment:"parent",update:function(){b.updateCollection()}}).disableSelection(),b.updateCollection()},addMedias:function(){var c,f=this,g=new d;a(g).on("ekyna.modal.content",function(b){if("html"!=b.contentType)throw"Unexpected modal content type.";c=new e(b.content),a(c).bind("ekyna.media-browser.media_delete",function(b){if(b.hasOwnProperty("media")){var c=f.$elem.find(".ekyna-media-collection-media").not(".ekyna-media-collection-add");c.each(function(){var c=a(this);b.media.id==c.find("input").val()&&f.removeMedia(c,!1)})}})}),a(g).on("ekyna.modal.load_fail",function(){alert("Failed to load media browser.")}),a(g).on("ekyna.modal.button_click",function(a){if("submit"==a.buttonId&&c){var b=c.getSelection();for(var d in b)b.hasOwnProperty(d)&&f.createMedia(b[d]);f.updateCollection(),g.getDialog().close()}}),a(g).on("ekyna.modal.shown",function(){c&&c.init()}),a(g).on("ekyna.modal.hide",function(){c&&(c=null)});var h={mode:"multiple_selection"};f.config.types.length>0&&(h.types=this.config.types),g.load({url:b.generate("ekyna_media_browser_admin_modal",h)})},updateCollection:function(){var b=this,c=b.$elem.find(".ekyna-media-collection-media").not(".ekyna-media-collection-add"),d=c.size()-1;c.each(function(b){var c=a(this);c.find('input[data-role="position"]').val(b),0==b?c.find('[data-role="move-left"]').addClass("disabled"):c.find('[data-role="move-left"]').removeClass("disabled"),b==d?c.find('[data-role="move-right"]').addClass("disabled"):c.find('[data-role="move-right"]').removeClass("disabled")}),b.createAddButton()},createMedia:function(b){for(var d=this,e=this.$elem.attr("data-prototype"),f=this.$elem.attr("data-prototype-name"),g=this.$elem.find(".ekyna-media-collection-media").size(),h=e.match(/id="(.*?)"/),i=new RegExp(f,"g");a("#"+h[1].replace(i,g)).size()>0;)g++;e=e.replace(i,g),e=e.replace(/__id__/g,h[1].replace(i,g));var j=a(e);j.removeClass("ekyna-media-collection-add");var k=a(c.render(EkynaMediaBundle.thumb.html,{media:b,controls:d.config.controls,selector:!1}));k.data("media",b),j.find(".media-thumb").replaceWith(k),j.find("input").val(b.id),d.$elem.append(j)},createAddButton:function(){var b=this,c=b.$elem.find(".ekyna-media-collection-add");if(1==c.length)return void c.detach().appendTo(b.$elem);c.length>1&&c.remove();for(var d=this.$elem.attr("data-prototype"),e=this.$elem.attr("data-prototype-name"),f=this.$elem.find(".ekyna-media-collection-media").size(),g=d.match(/id="(.*?)"/),h=new RegExp(e,"g");a("#"+g[1].replace(h,f)).size()>0;)f++;d=d.replace(h,f),d=d.replace(/__id__/g,g[1].replace(h,f));var i=a(d);b.$elem.append(i)},moveLeft:function(a){a.find('[data-role="move-left"]').hasClass("disabled")||(a.prev().before(a.detach()),this.updateCollection())},moveRight:function(a){a.find('[data-role="move-right"]').hasClass("disabled")||(a.next().after(a.detach()),this.updateCollection())},removeMedia:function(a,b){if(!a.find('[data-role="remove"]').hasClass("disabled")){if(b&&!confirm("Souhaitez-vous réellement retirer cet élément ?"))return;a.remove(),this.updateCollection()}}},{init:function(b){b.each(function(){new f(a(this)).init()})}}});